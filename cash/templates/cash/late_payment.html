{% extends "../layout.html" %}
{% load custom_filters %}

<!-- DataTables CSS and JavaScript -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>


{% block header %}
<span class="navbar-brand mb-0 h1 text-white">Paiement en Retards {{ current_annee_scolaire.nom }}</span>
          
    
            <!-- Undo and Redo Icons -->
            <div class="ml-2 d-flex align-items-stretch">
                <button class="class-card mr-3 hidden-print" onclick="myFunction()"><span class="glyphicon glyphicon-print" aria-hidden="true"></span> Print</button>
                <a href="{% url 'home' %}" class="class-card mr-3">Cancel</a>
                <button class="class-card mr-3" id="undo-button" title="Undo">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="class-card mr-3" id="redo-button" title="Redo">
                    <i class="fas fa-redo"></i>
                </button>
                <h2 class='mr-3 text-white'><strong>{{ page_identifier }}</strong></h2>
            </div>
{% endblock header %}

{% block content %}

<style>
    .table-container {
        max-width: 100%;
        overflow-x: auto;
        border-radius: 10px;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .table th,
    .table td {
        padding: 5px 8px !important; /* Reduced padding */
        text-align: center;
        font-size: 12px; /* Smaller font size */
    }

    .table th {
        background-color: #333;
        color: #fff;
        text-transform: uppercase;
    }

    .class-header-row {
        background-color: #f8f9fa !important; /* Light gray background */
        font-weight: bold;
        text-align: left;
    }

    .highlight-negative {
        color: red; /* Highlight negative values in red */
        font-weight: bold; /* Make it bold for emphasis */
    }
</style>

<div class="table-container">
  
    
    <table class="table table-striped table-bordered" id="delaysTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Sex</th>
                <th>CS_PY</th>
                <th>SCO Paid</th>
                <th>SCO Exigible</th>
                <th>Diff. SCO</th>
                <th>CAN Paid</th>
                <th>CAN Exigible</th>
                <th>Diff. CAN</th>
                <th>Retards</th>
                <th>Note</th>
                <th>% Paid</th>
                <th>Retard (%)</th> <!-- New column for remaining percentage -->
            </tr>
        </thead>
        <tbody>
            {% for school, classes in data.items %}
                {% for class_name, class_info in classes.items %}
                    <!-- Class Header Row -->
                    <tr class="class-header-row">
                        <td colspan="14">Class: {{ class_name }} | Total Diff SCO: {{ class_info.total_diff_sco|default:"-" }} | Total Diff CAN: {{ class_info.total_diff_can|default:"-" }}</td>
                    </tr>

                    <!-- Student Rows -->
                    {% for student in class_info.students %}
                    <tr>
                        <td>{{ student.id }}</td>
                        <td>{{ student.nom }}</td>
                        <td>{{ student.prenom }}</td>
                        <td>{{ student.sex }}</td>
                        <td>{{ student.cs_py }}</td>

                        <!-- SCO Paid -->
                        <td>{% if student.sco_paid == 0 %}-{% else %}{{ student.sco_paid|format_amount }}{% endif %}</td>

                        <!-- SCO Exigible -->
                        <td>{% if student.sco_exigible == 0 %}-{% else %}{{ student.sco_exigible|format_amount }}{% endif %}</td>

                        <!-- Diff SCO -->
                        <td class="{% if student.diff_sco > 0 %}highlight-negative{% endif %}">
                            {% if student.diff_sco == 0 %}-{% else %}{{ student.diff_sco|format_amount }}{% endif %}
                        </td>

                        <!-- CAN Paid -->
                        <td>{% if student.can_paid == 0 %}-{% else %}{{ student.can_paid|format_amount }}{% endif %}</td>

                        <!-- CAN Exigible -->
                        <td>{% if student.can_exigible == 0 %}-{% else %}{{ student.can_exigible|format_amount }}{% endif %}</td>

                        <!-- Diff CAN -->
                        <td class="{% if student.diff_can > 0 %}highlight-negative{% endif %}">
                            {% if student.diff_can == 0 %}-{% else %}{{ student.diff_can|format_amount }}{% endif %}
                        </td>

                        <!-- Retards -->
                        <td>{% if student.retards == 0 %}-{% else %}{{ student.retards|format_amount }}{% endif %}</td>

                        <!-- Note -->
                        <td>{{ student.note }}</td>

                        <!-- Percentage Paid -->
                        <td>{{ student.percentage_paid }}%</td>

                        <!-- Remaining Percentage (Retard) -->
                        <td class="{% if student.remaining_percentage > 0 %}red-retard{% endif %}">
                            {% if student.remaining_percentage > 0 %}
                                -{{ student.remaining_percentage|floatformat:1 }}%
                            {% else %}
                                -
                            {% endif %}
                        </td> <!-- Displaying as a percentage with a minus sign -->
                    </tr>
                    {% endfor %}
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>

</div>

<!-- Initialize DataTables with Print Button Functionality -->
<script type="text/javascript">

    function myFunction() {
        window.print();
    }
    $(document).ready(function() {
        // Initialize DataTable with Print Button
        var table = $('#delaysTable').DataTable({
            "searching": false, // Disable search input
            "lengthChange": false, // Disable "Show entries" dropdown
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.21/i18n/French.json"
            },
            dom: 'Bfrtip', // Define the layout of the table with buttons
            buttons: [
                {
                    extend: 'print',
                    text: 'Print',
                    title: 'Late Payment Report', // Title for the print page
                    customize: function (win) {
                        $(win.document.body)
                            .css('font-size', '12pt') // Set font size for printed document
                            .prepend(
                                '<h3 style="text-align:center;">Late Payment Report</h3>' // Add title to printed document
                            );
                        $(win.document.body).find('table')
                            .addClass('compact') // Add compact class for better layout
                            .css('font-size', '10pt'); // Adjust font size for table
                    }
                }
            ]
        });

        // Trigger Print Button from Header
        $('#printButton').on('click', function() {
            table.button(0).trigger(); // Trigger the print button programmatically
        });
    });
</script>

{% endblock %}
